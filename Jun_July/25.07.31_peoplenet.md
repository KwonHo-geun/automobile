## Nvidia PeopleNet 정리


---
### 실습 정리
<details> 
<summary>더보기</summary>strong>
 1. 셀 | 시스템 패키지 설치

```

# APT 인덱스 갱신 후 필수 패키지 설치
apt update && apt install -y unzip wget ffmpeg
# ㆍunzip  : NGC CLI ZIP 압축 해제용
# ㆍwget   : 원격 파일 다운로드
# ㆍffmpeg : YouTube MP4 코덱 호환‧프레임 추출

```

2. 셀 | 작업 디렉터리 확인

```

# 현재 디렉터리(컨테이너 기본 경로) 확인
pwd      # 예상 출력: /workspace

```

3. 셀 | 기존 NGC CLI 탐색

```
# 이미 NGC CLI 가 설치되어 있는지 검색
find /workspace -name "*ngc*" -type f
```

4. 셀 | NGC CLI 다운로드

```
# NVIDIA 공식 사이트에서 CLI ZIP 받아오기
wget -q https://ngc.nvidia.com/downloads/ngccli_reg_linux.zip
```

5. 셀 | NGC CLI 압축 해제

```
# ZIP 파일 풀어서 ./ngc-cli/ 디렉터리 생성
unzip ngccli_reg_linux.zip
```

6. 셀 | Python 라이브러리 설치

```
# PeopleNet 추론 및 YouTube 다운로드용 파이썬 패키지
pip install onnxruntime yt-dlp opencv-python numpy
# ㆍonnxruntime : ONNX 모델 추론 엔진
# ㆍyt-dlp      : YouTube 영상 다운로드
# ㆍopencv-python: 프레임 처리·시각화
# ㆍnumpy       : 수치 연산
```

7. 셀 | PeopleNet 디버그 실행

```
############################################################
# DebugNVIDIAPeopleNet 클래스 정의 및 5-프레임 테스트 실행 #
############################################################
import cv2, numpy as np, subprocess, os, onnxruntime as ort, yt_dlp

class DebugNVIDIAPeopleNet:
    def __init__(self):
        print("🚀 디버깅 NVIDIA PeopleNet 시작...")
        # ① 모델 경로 및 클래스/색상 정의
        self.model_path = (
            "/workspace/peoplenet_vpruned_quantized_decrypted_v2.3.4/"
            "resnet34_peoplenet_int8.onnx"
        )
        self.classes = ['person', 'bag', 'face']
        self.colors  = [(0,255,0), (255,0,0), (0,0,255)]
        # ② 모델 로드
        self.setup_model()

    # ---------------- 모델 로드 & 더미 추론 ---------------- #
    def setup_model(self):
        print(f"📁 모델 경로 확인: {self.model_path}")
        if not os.path.exists(self.model_path):
            return self._find_model()
        # CPUExecutionProvider → 필요시 CUDAExecutionProvider 로 변경
        self.session = ort.InferenceSession(
            self.model_path, providers=['CPUExecutionProvider']
        )
        self.input_name  = self.session.get_inputs()[0].name
        self.output_names = [o.name for o in self.session.get_outputs()]
        print("✅ 모델 로드 완료, 더미 테스트 실행")
        self._test_inference()

    def _test_inference(self):
        dummy = np.random.randn(1,3,544,960).astype(np.float32)
        outs  = self.session.run(self.output_names, {self.input_name: dummy})
        for idx, o in enumerate(outs):
            print(f"  ↳ 출력{idx}: {o.shape}, 값범위 [{o.min():.3f}, {o.max():.3f}]")

    # ------------------- 전처리 & 추론 -------------------- #
    def _preprocess(self, frame):
        f = cv2.resize(frame,(960,544))
        f = cv2.cvtColor(f, cv2.COLOR_BGR2RGB).astype(np.float32)/255.0
        f = np.transpose(f,(2,0,1))[None,...]     # (1,3,544,960)
        return f

    def detect(self, frame):
        inp = self._preprocess(frame)
        outs = self.session.run(self.output_names,{self.input_name: inp})
        return self._postprocess(outs[0], frame.shape)

    # ---------------- 후처리 (임계값+NMS) ------------------ #
    def _postprocess(self, pred, oshape):
        if pred.ndim==4: pred = pred[0]           # (3,34,60)
        H,W = oshape[:2]
        detections = []
        for cid, cname in enumerate(self.classes):
            grid = pred[cid]; thr=0.1
            ys,xs = np.where(grid>thr)
            for y,x in zip(ys[:5], xs[:5]):       # 상위 5개만
                conf = float(grid[y,x])
                cx,cy = (x+0.5)/60, (y+0.5)/34
                bw,bh = (0.12,0.20) if cname=='person' else \
                        (0.06,0.08) if cname=='bag'    else (0.04,0.05)
                x1,y1 = int((cx-bw/2)*W), int((cy-bh/2)*H)
                x2,y2 = int((cx+bw/2)*W), int((cy+bh/2)*H)
                detections.append(
                    dict(bbox=[x1,y1,x2,y2], confidence=conf,
                         class_id=cid, class_=cname)
                )
        return detections

    # ------------------- 유튜브 다운로드 ------------------- #
    @staticmethod
    def download_mp4(url):
        out = "/workspace/debug_input_video.mp4"
        subprocess.run(["yt-dlp","-f","best[height<=720]","-o",out,url],
                       check=True)
        return out if os.path.exists(out) else None

# ---------------------- 런처 ----------------------------- #
def run_debug():
    dbg = DebugNVIDIAPeopleNet()
    video = dbg.download_mp4("https://www.youtube.com/watch?v=SzRzYvQq0aQ")
    cap = cv2.VideoCapture(video); frame_ids = [0,100,200,300,400]
    for fid in frame_ids:
        cap.set(cv2.CAP_PROP_POS_FRAMES,fid)
        ok,frame = cap.read();  print(f"\n🎯 Frame {fid}")
        if ok:
            dets = dbg.detect(frame)
            for d in dets:
                print(f"  → {d['class_']} {d['confidence']:.3f}")
    cap.release()

# 5개 프레임 샘플 검출 실행
run_debug()

```

</strong></summary>
